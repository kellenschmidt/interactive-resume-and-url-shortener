defaults: &defaults
  working_directory: ~/circleci-workspace

version: 2
jobs:
  build:
    <<: *defaults
    docker:
      - image: circleci/node:9.11
    environment:
      TEST_RESULTS: /tmp/test-results
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Save version number
          command: echo "v$CIRCLE_BUILD_NUM" > app-version.txt
      - restore_cache:
          keys:
          - dependencies-v1-{{ checksum "package-lock.json" }}
          - dependencies-v1-
      - run:
          name: Install dependencies
          command: npm install
      - save_cache:
          paths:
            - node_modules
          key: dependencies-v1-{{ checksum "package-lock.json" }}
      - run:
          name: Run tests
          command: mkdir -p $TEST_RESULTS && npm test $TEST_RESULTS/test_results.txt
      - store_test_results:
          path: /tmp/test-results
      - setup_remote_docker
      - run:
          name: Build with Docker
          command: |
            TAG=v$CIRCLE_BUILD_NUM
            docker build --build-arg APP_VERSION=$TAG -t $DOCKER_USER/$CIRCLE_PROJECT_REPONAME:$TAG -t $DOCKER_USER/$CIRCLE_PROJECT_REPONAME:latest .
            IMAGE_SHA=$(docker image ls --digests --format '{{.Digest}}' $DOCKER_USER/$CIRCLE_PROJECT_REPONAME | head -n 1)
            docker image ls --digests --format '{{.Digest}}' $DOCKER_USER/$CIRCLE_PROJECT_REPONAME | head -n 1 > image_sha.txt
            docker run -d $DOCKER_USER/$CIRCLE_PROJECT_REPONAME:$TAG
            CONTAINER_ID=$(docker ps -alq)
            docker cp ${CONTAINER_ID}:/usr/local/apache2/htdocs ./dist
            docker stop $CONTAINER_ID
      - run:
          name: Upload to Docker Hub
          command: |
            echo $TAG
            echo $IMAGE_SHA
            cat image_sha.txt
            TAG=v$CIRCLE_BUILD_NUM
            docker login -u $DOCKER_USER -p $DOCKER_PASS
            docker push $DOCKER_USER/$CIRCLE_PROJECT_REPONAME:$TAG
            docker push $DOCKER_USER/$CIRCLE_PROJECT_REPONAME:latest
      - save_cache:
          paths:
            - dist
          key: dist-v1-$IMAGE_SHA
      - save_cache:
          paths:
            - app-version.txt
          key: version-v1-{{ checksum "image_sha.txt" }}

  deploy-kellenforthewin:
    machine:
      enabled: true
    steps:
      - add_ssh_keys:
          fingerprints:
            - "f6:59:4f:20:95:32:55:c6:95:fc:43:5e:76:aa:ac:f4"
      - run:
          name: Deploy over SSH
          command: |
            ssh $SSH_USER@$SSH_HOST "bash ~/kspw-kubernetes/bin/deploy.sh $DOCKER_USER $CIRCLE_PROJECT_REPONAME"

  deploy-kellenschmidtcom:
    machine:
      enabled: true
    steps:
      - add_ssh_keys:
          fingerprints:
            - "86:20:9b:53:2d:a6:f6:14:4e:02:64:27:87:d9:d6:b5"
      - run:
          name: Deploy over SSH
          command: |
            ssh $SSH_USER@$SSH_HOST "bash ~/kspw-kubernetes/bin/deploy.sh $DOCKER_USER $CIRCLE_PROJECT_REPONAME"

  publish-github-release:
    <<: *defaults
    docker:
      - image: cibuilds/github:0.10
    steps:
      - run:
          name: "Get SHA of latest docker build"
          command: |
            DOCKER_HUB_TOKEN=$(curl "https://auth.docker.io/token?service=registry.docker.io&scope=repository:$DOCKER_USER/$CIRCLE_PROJECT_REPONAME:pull" | jq -r '.token')
            echo $DOCKER_HUB_TOKEN
            IMAGE_SHA=$(curl -H "Authorization: Bearer $DOCKER_HUB_TOKEN" -H "Accept: application/vnd.docker.distribution.manifest.v2+json" https://registry.hub.docker.com/v2/kellenschmidt/interactive-resume-and-url-shortener/manifests/latest | jq -r '.config.digest')
            echo $IMAGE_SHA
            curl -H "Authorization: Bearer $DOCKER_HUB_TOKEN" -H "Accept: application/vnd.docker.distribution.manifest.v2+json" https://registry.hub.docker.com/v2/kellenschmidt/interactive-resume-and-url-shortener/manifests/latest | jq -r '.config.digest' > image_sha.txt
      - restore_cache:
          keys:
          - dist-v1-$IMAGE_SHA
      - restore_cache:
          keys:
          - version-v1-{{ checksum "image_sha.txt" }}
      - run:
          name: "Publish Release on GitHub"
          command: |
            VERSION=$(cat app-version.txt)
            ARTIFACT_DIR=artifacts
            ARTIFACT_NAME=irus_dist_$VERSION
            apk update
            apk add zip
            mkdir $ARTIFACT_DIR
            zip -r $ARTIFACT_DIR/$ARTIFACT_NAME.zip ./dist
            tar -czf $ARTIFACT_DIR/$ARTIFACT_NAME.tar.gz ./dist
            ghr -t $GITHUB_TOKEN -u $CIRCLE_PROJECT_USERNAME -r $CIRCLE_PROJECT_REPONAME -c $CIRCLE_SHA1 -delete $VERSION $ARTIFACT_DIR

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build:
          context: kellenforthewin
          filters:
            branches:
              only: dev
      - deploy-kellenforthewin:
          requires:
            - build
          context: kellenforthewin
          filters:
            branches:
              only: dev
      - publish-github-release:
          context: kellenschmidt.com
          filters:
            branches:
              only: master
      # - deploy-kellenschmidtcom:
      #     context: kellenschmidt.com
      #     filters:
      #       branches:
      #         only: master
